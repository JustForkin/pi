'use strict';var THREE,TWEEN,V3D={};V3D.ToRad=Math.PI/180;
V3D.Base=function(){this.container=document.getElementById("container");this.f=[0,0,0,0];this.key=[0,0,0,0,0,0,0];this.cfg={speed:0.025,maxSpeed:0.25,G:0.4,g:0,onGround:!0,posY:0};this.cam={horizontal:90,vertical:90,distance:3,py:1.2};this.mouse={down:!1,ox:0,oy:0,h:0,v:0,mx:0,my:0};this.bullets=[];this.bulletMoves=[];this.srcImage=["assets/hero.jpg"];this.srcModel=["assets/base.sea","assets/hero.sea"];this.imgs=[];this.textures=[];this.meshs={};this.delta=this.n=0;this.init();this.miniMap=new V3D.Minimap;
this.loadImages()};
V3D.Base.prototype={constructor:V3D.Base,loadImages:function(){var a=this,b=this.n;this.imgs[b]=new Image;this.imgs[b].onload=function(){a.n++;a.n===a.srcImage.length?a.endLoadImages():a.loadImages()};this.imgs[b].src=this.srcImage[b]},endLoadImages:function(){for(var a=this.imgs.length;a--;)this.textures[a]=new THREE.Texture(this.imgs[a]),this.textures[a].repeat.set(1,-1),this.textures[a].wrapS=this.textures[a].wrapT=THREE.RepeatWrapping,this.textures[a].needsUpdate=!0;this.n=0;this.loadModels()},
loadModels:function(){var a=this,b=this.n,d=new THREE.SEA3D(!0);d.onComplete=function(b){a.n++;for(var e=d.meshes.length;e--;)b=d.meshes[e],"hero"!==b.name&&a.scaleGeometry(b.geometry),a.meshs[b.name]=b;a.n===a.srcModel.length?a.endLoadModels():a.loadModels()};d.parser=THREE.SEA3D.DEFAULT;d.load(this.srcModel[b])},scaleGeometry:function(a,b){b=b||1;var d=(new THREE.Matrix4).makeScale(b,b,-b);a.applyMatrix(d);a.computeBoundingBox();a.computeBoundingSphere()},endLoadModels:function(){this.mapHeigth=
this.customShader();this.meshs.base.material=this.mapHeigth.clone();this.scene.add(this.meshs.base);var a=this.customShader(),a=new THREE.Mesh(this.meshs.base.geometry.clone(),a);this.miniMap.scene.add(a);this.player.addModel(this.meshs.hero,this.textures[0])},init:function(){this.clock=new THREE.Clock;this.levelOrigin=new THREE.Vector3(0,0,0);this.level=new THREE.Vector3(0,0,0);this.ease=new THREE.Vector3;this.easeRot=new THREE.Vector3;this.vs=new THREE.Vector3(window.innerWidth,window.innerHeight,
window.innerWidth/window.innerHeight);this.scene=new THREE.Scene;this.camera=new THREE.PerspectiveCamera(55,this.vs.z,0.1,1E3);this.scene.add(this.camera);this.content=new THREE.Object3D;this.scene.add(this.content);this.bulletContent=new THREE.Object3D;this.scene.add(this.bulletContent);this.bulletMat=new THREE.MeshBasicMaterial({color:16777215});this.bulletGeo=new THREE.SphereGeometry(8,6,6);var a=new THREE.CylinderGeometry(0,0.3,1,3);a.applyMatrix((new THREE.Matrix4).makeTranslation(0,5,0));a.applyMatrix((new THREE.Matrix4).makeRotationX(Math.PI/
2));this.marker=new THREE.Mesh(a,new THREE.MeshBasicMaterial({color:65280}));this.scene.add(this.marker);this.player=new V3D.Player;this.player.setPosition(0,this.cfg.posY+0.5,0);this.scene.add(this.player.obj);this.moveCamera();this.projector=new THREE.Projector;this.raycaster=new THREE.Raycaster;this.renderer=new THREE.WebGLRenderer({precision:"mediump",devicePixelRatio:1,antialias:!1});this.renderer.setClearColor(262662,1);this.renderer.setSize(this.vs.x,this.vs.y);this.renderer.sortObjects=!1;
this.renderer.sortElements=!1;this.container.appendChild(this.renderer.domElement);var b=this;window.addEventListener("resize",function(a){b.resize()},!1);this.activeMouse();this.bindKeys()},render:function(){this.delta=this.clock.getDelta();this.move();this.player.loop(this.delta);this.renderer.render(this.scene,this.camera);this.f[2]=Date.now();this.f[2]-1E3>this.f[1]&&(this.f[1]=this.f[2],this.f[0]=this.f[3],this.f[3]=0);this.f[3]++},resize:function(){this.vs.set(window.innerWidth,window.innerHeight,
window.innerWidth/window.innerHeight);this.camera.aspect=this.vs.z;this.camera.updateProjectionMatrix();this.renderer.setSize(this.vs.x,this.vs.y)},move:function(){this.key[0]&&(this.ease.z=this.ease.z>this.cfg.maxSpeed?this.cfg.maxSpeed:this.ease.z+this.cfg.speed);this.key[1]&&(this.ease.z=this.ease.z<-this.cfg.maxSpeed?-this.cfg.maxSpeed:this.ease.z-this.cfg.speed);this.key[2]&&(this.ease.x=this.ease.x>this.cfg.maxSpeed?this.cfg.maxSpeed:this.ease.x+this.cfg.speed);this.key[3]&&(this.ease.x=this.ease.x<
-this.cfg.maxSpeed?-this.cfg.maxSpeed:this.ease.x-this.cfg.speed);this.key[0]||this.key[1]||(this.ease.z=this.ease.z>this.cfg.speed?this.ease.z-this.cfg.speed:this.ease.z<-this.cfg.speed?this.ease.z+this.cfg.speed:0);this.key[2]||this.key[3]||(this.ease.x=this.ease.x>this.cfg.speed?this.ease.x-this.cfg.speed:this.ease.x<-this.cfg.speed?this.ease.x+this.cfg.speed:0);var a=0;0!==this.ease.z||0!==this.ease.x?(0<this.ease.z?(this.player.WalkFront(),a=1):0>this.ease.z&&(this.player.WalkBack(),a=-1),0>
this.ease.x?this.player.stepLeft(a):0<this.ease.x&&this.player.stepRight(a)):this.player.stopWalk();if(0!=this.ease.x||0!=this.ease.z||this.mouse.down){this.easeRot.y=this.cam.horizontal*V3D.ToRad;a=this.unwrapDegrees(Math.round(this.cam.horizontal));this.easeRot.x=Math.sin(this.easeRot.y)*this.ease.x+Math.cos(this.easeRot.y)*this.ease.z;this.easeRot.z=Math.cos(this.easeRot.y)*this.ease.x-Math.sin(this.easeRot.y)*this.ease.z;this.player.setRotation(-(this.cam.horizontal+90)*V3D.ToRad);this.level.x=
this.levelOrigin.x-this.easeRot.x;this.level.z=this.levelOrigin.z+this.easeRot.z;this.miniMap.drawMap();var b=0,d=0,c=this.miniMap.lock;45<=a&&135>=a?(this.level.z<this.levelOrigin.z&&(c[0]||c[4]||c[5]||(d=1)),this.level.z>this.levelOrigin.z&&(c[1]||c[6]||c[7]||(d=1)),this.level.x<this.levelOrigin.x&&(c[2]||c[4]||c[6]||(b=1)),this.level.x>this.levelOrigin.x&&(c[3]||c[5]||c[7]||(b=1))):-45>=a&&-135<=a?(this.level.z>this.levelOrigin.z&&(c[0]||c[4]||c[5]||(d=1)),this.level.z<this.levelOrigin.z&&(c[1]||
c[6]||c[7]||(d=1)),this.level.x>this.levelOrigin.x&&(c[2]||c[4]||c[6]||(b=1)),this.level.x<this.levelOrigin.x&&(c[3]||c[5]||c[7]||(b=1))):45>a&&-45<a?(this.level.z>this.levelOrigin.z&&(c[2]||c[4]||c[6]||(d=1)),this.level.z<this.levelOrigin.z&&(c[3]||c[5]||c[7]||(d=1)),this.level.x<this.levelOrigin.x&&(c[0]||c[4]||c[5]||(b=1)),this.level.x>this.levelOrigin.x&&(c[1]||c[6]||c[7]||(b=1))):(this.level.z<this.levelOrigin.z&&(c[2]||c[4]||c[6]||(d=1)),this.level.z>this.levelOrigin.z&&(c[3]||c[5]||c[7]||(d=
1)),this.level.x>this.levelOrigin.x&&(c[0]||c[4]||c[5]||(b=1)),this.level.x<this.levelOrigin.x&&(c[1]||c[6]||c[7]||(b=1)));b&&(this.levelOrigin.x=this.level.x);d&&(this.levelOrigin.z=this.level.z);this.level.y=this.miniMap.posY+this.cfg.posY;this.levelOrigin.y=this.level.y;this.cfg.g=this.cfg.onGround?0:this.cfg.G;this.ease.y+=this.cfg.g*this.delta;this.miniMap.updatePosition(this.levelOrigin.x,-this.easeRot.y,this.levelOrigin.z);this.player.lerp(this.levelOrigin,0.5);this.moveCamera()}},moveCamera:function(){var a=
this.player.getPosition().clone();a.add(new THREE.Vector3(0,this.cam.py,0));this.camera.position.copy(this.Orbit(a,this.cam.horizontal,this.cam.vertical,this.cam.distance));this.camera.lookAt(a)},rayTest:function(a){if(0<this.content.children.length){var b=new THREE.Vector3(this.mouse.mx,this.mouse.my,1);this.projector.unprojectVector(b,this.camera);this.raycaster.set(this.camera.position,b.sub(this.camera.position).normalize());b=this.raycaster.intersectObjects(this.content.children);0<b.length&&
(this.marker.position.set(0,0,0),b[0].face&&this.marker.lookAt(b[0].face.normal),this.marker.position.copy(b[0].point),a&&this.shoot())}},shoot:function(){var a=this.bullets.length,b=new THREE.Mesh(this.bulletGeo,this.bulletMat);this.bulletContent.add(b);this.bullet.position.copy(this.player.position);this.bulletMoves[a]=this.marker.position.clone();this.bullets[a]=b},updateBullets:function(){for(var a=this.bullets.length;a--;)0.01>this.bullets[a].position.distanceTo(this.bulletMoves[a])?setTimeout(this.destroyBullet,
1E3,a):this.bullets[a].position.lerp(this.bulletMoves[a],0.1)},destroyBullet:function(a){this.bulletContent.remove(this.bullets[a]);this.bullets.slice(a,1);this.bulletMoves.slice(a,1)},activeMouse:function(){var a=this,b=document.body;document.addEventListener("contextmenu",function(a){a.preventDefault()},!1);b.addEventListener?(b.addEventListener("mousemove",function(b){a.onMouseMove(b)},!1),b.addEventListener("mousedown",function(b){a.onMouseDown(b)},!1),b.addEventListener("mouseup",function(b){a.onMouseUp(b)},
!1),b.addEventListener("mouseout",function(b){a.onMouseUp(b)},!1),b.addEventListener("touchstart",function(b){a.onMouseDown(b)},!1),b.addEventListener("touchend",function(b){a.onMouseUp(b)},!1),b.addEventListener("touchmove",function(b){a.onMouseMove(b)},!1),b.addEventListener("mousewheel",function(b){a.onMouseWheel(b)},!1),b.addEventListener("DOMMouseScroll",function(b){a.onMouseWheel(b)},!1)):b.attachEvent&&(b.attachEvent("onmousemove",function(b){a.onMouseMove(b)},!1),b.attachEvent("onmousedown",
function(b){a.onMouseDown(b)},!1),b.attachEvent("onmouseup",function(b){a.onMouseUp(b)},!1),b.attachEvent("onmouseout",function(b){a.onMouseUp(b)},!1),b.attachEvent("ontouchstart",function(b){a.onMouseDown(b)},!1),b.attachEvent("ontouchend",function(b){a.onMouseUp(b)},!1),b.attachEvent("ontouchmove",function(b){a.onMouseMove(b)},!1),b.attachEvent("onmousewheel",function(b){a.onMouseWheel(b)}))},onMouseDown:function(a){a.preventDefault();var b;a.touches?(b=a.clientX||a.touches[0].pageX,a=a.clientY||
a.touches[0].pageY):(b=a.clientX,a=a.clientY);this.mouse.down=!0;this.mouse.mx=b/this.vs.x*2-1;this.mouse.my=2*-(a/this.vs.y)+1;this.mouse.ox=b;this.mouse.oy=a;this.mouse.h=this.cam.horizontal;this.mouse.v=this.cam.vertical},onMouseUp:function(a){a.preventDefault();this.mouse.down=!1;document.body.style.cursor="auto"},onMouseMove:function(a){a.preventDefault();var b;a.touches?(b=a.clientX||a.touches[0].pageX,a=a.clientY||a.touches[0].pageY):(b=a.clientX,a=a.clientY);this.mouse.down?(document.body.style.cursor=
"move",this.cam.horizontal=0.3*(b-this.mouse.ox)+this.mouse.h,this.cam.vertical=0.3*-(a-this.mouse.oy)+this.mouse.v):(this.mouse.mx=b/this.vs.x*2-1,this.mouse.my=2*-(a/this.vs.y)+1,this.rayTest())},onMouseWheel:function(a){a.preventDefault()},bindKeys:function(){var a=this;document.onkeydown=function(b){b=b||window.event;switch(b.keyCode){case 38:case 87:case 90:a.key[0]=1;break;case 40:case 83:a.key[1]=1;break;case 37:case 65:case 81:a.key[2]=1;break;case 39:case 68:a.key[3]=1;break;case 17:case 67:a.key[4]=
1;break;case 69:a.key[5]=1;break;case 32:a.key[6]=1;break;case 16:a.key[7]=1}};document.onkeyup=function(b){b=b||window.event;switch(b.keyCode){case 38:case 87:case 90:a.key[0]=0;break;case 40:case 83:a.key[1]=0;break;case 37:case 65:case 81:a.key[2]=0;break;case 39:case 68:a.key[3]=0;break;case 17:case 67:a.key[4]=0;break;case 69:a.key[5]=0;break;case 32:a.key[6]=0;break;case 16:a.key[7]=0}};self.focus()},unwrapDegrees:function(a){a%=360;180<a&&(a-=360);-180>a&&(a+=360);return a},Orbit:function(a,
b,d,c){var e=new THREE.Vector3;d*=V3D.ToRad;b*=V3D.ToRad;e.x=c*Math.sin(d)*Math.cos(b)+a.x;e.z=c*Math.sin(d)*Math.sin(b)+a.z;e.y=c*Math.cos(d)+a.y;return e},customShader:function(){return new THREE.ShaderMaterial({uniforms:{deep:{type:"f",value:0.03904}},attributes:{},vertexShader:"uniform float deep;\nvarying float dy;\nvarying vec4 vc;\nvoid main(void) {\ngl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\ndy = position.y*deep;\nvc = vec4(dy,dy,dy, 1.0);\n}",fragmentShader:"precision lowp float;\nvarying vec4 vc;\nvoid main(void) { gl_FragColor = vc; }"})}};V3D.Minimap=function(){this.ar8="undefined"!=typeof Uint8Array?Uint8Array:Array;this.miniSize={w:64,h:64,f:0.25};this.cc={r:255,g:0,b:0,a:255};this.miniGlCanvas=document.createElement("canvas");this.miniTop=document.createElement("canvas");this.mapTest=document.createElement("canvas");this.miniGlCanvas.width=this.miniTop.width=this.miniSize.w;this.miniGlCanvas.height=this.miniTop.height=this.miniSize.h;this.mapTest.width=16;this.mapTest.height=16;this.miniGlCanvas.style.cssText="position:absolute; bottom:10px; left:10px;";
this.miniTop.style.cssText="position:absolute; bottom:10px; left:10px;";this.mapTest.style.cssText="position:absolute; bottom:32px; left:32px;";var a=document.body;a.appendChild(this.miniGlCanvas);a.appendChild(this.miniTop);a.appendChild(this.mapTest);this.posY=0;this.init()};
V3D.Minimap.prototype={constructor:V3D.Minimap,init:function(){this.setMapTestSize(8);this.renderer=new THREE.WebGLRenderer({canvas:this.miniGlCanvas,precision:"lowp",antialias:!1});this.renderer.setSize(this.miniSize.w,this.miniSize.h,!0);this.renderer.sortObjects=!1;this.renderer.sortElements=!1;this.renderer.setClearColor(16711680,1);this.scene=new THREE.Scene;this.camera=new THREE.OrthographicCamera(-3,3,3,-3,0.1,1E3);this.camera.position.y=100;this.camera.lookAt(new THREE.Vector3(0,0,0));this.player=
new THREE.Object3D;this.player.position.set(0,0,0);this.scene.add(this.player);this.player.add(this.camera);this.gl=this.renderer.getContext();this.initTopMap()},updatePosition:function(a,b,d){this.player.position.x=a;this.player.position.z=d;this.player.rotation.y=b},createHeightGradMaterial:function(a){var b=document.createElement("canvas"),d=b.getContext("2d");b.width=16;b.height=256;for(var c=d.createLinearGradient(0,0,0,256),e=a[0].length;e--;)c.addColorStop(a[0][e],a[1][e]);d.fillStyle=c;d.fillRect(0,
0,16,256);a=new THREE.Texture(b);a.needsUpdate=!0;return a},drawMap:function(){this.renderer.render(this.scene,this.camera);this.gl.readPixels(this.zsize[0],this.zsize[1],this.zsize[2],this.zsize[2],this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.zone);for(var a=8;a--;)this.lock[a]=this.colorTest(this.pp[a]);this.posY=this.zone[this.pp[8]+1]/10;this.player.position.y=this.posY;this.ctxTest&&this.drawMapTest()},colorTest:function(a){var b=0,d=this.zone,c=this.cc;d[a]==c.r&&d[a+1]==c.g&&d[a+2]==c.b&&d[a+3]==
c.a&&(b=1);return b},heightTest:function(a){return this.zone[a]||0},setMapTestSize:function(a){this.lock=new this.ar8(a);var b=4*a*a*4;this.pp=[b-4*a,4*a,0.5*b,0.5*b+(8*a-4),844,888,136,180,0.5*b+4*a];this.zone=new this.ar8(b);this.zsize=[0.5*this.miniSize.w-a,0.5*this.miniSize.h-a,2*a]},initTopMap:function(){var a=this.miniTop.getContext("2d");a.fillStyle="black";a.fillRect(0,0,1,this.miniSize.h);a.fillRect(this.miniSize.w-1,0,1,this.miniSize.h);a.fillRect(1,0,this.miniSize.w-2,1);a.fillRect(1,this.miniSize.h-
1,this.miniSize.w-2,1);a.save();a.translate(0.5*this.miniSize.w,0.5*this.miniSize.h);this.drawPlayer(a);a.restore();this.ctxTest=this.mapTest.getContext("2d")},drawMapTest:function(){this.ctxTest.clearRect(0,0,16,16);for(var a=this.ctxTest.createImageData(16,16),b=a.data,d=7;d--;)b[d]=0;this.lock[1]&&this.dp(b,this.pp[0]);this.lock[0]&&this.dp(b,this.pp[1]);this.lock[2]&&this.dp(b,this.pp[2]);this.lock[3]&&this.dp(b,this.pp[3]);this.lock[6]&&this.dp(b,this.pp[4]);this.lock[7]&&this.dp(b,this.pp[5]);
this.lock[4]&&this.dp(b,this.pp[6]);this.lock[5]&&this.dp(b,this.pp[7]);this.ctxTest.putImageData(a,0,0)},dp:function(a,b){a[b]=255;a[b+1]=255;a[b+3]=255},drawPlayer:function(a){a.fillStyle="rgba(255,255,200,0.2)";a.globalAlpha=1;a.beginPath();a.moveTo(0,0);a.lineTo(30,-30);a.lineTo(-30,-30);a.closePath();a.fill();a.fillStyle="rgba(200,200,100,1)";a.fillRect(-2,-2,4,4)}};V3D.Player=function(){this.obj=new THREE.Object3D;this.velocity=new THREE.Vector3(0,0,0);this.rotation=new THREE.Vector3(0,0,0);this.newRotation=new THREE.Vector3(0,0,0);this.model=!1;this.timeScale=1;this.timeToStep=0;this.isFrameStepping=!1;this.animLength=0;this.W={R:0};this.isMove=!1};
V3D.Player.prototype={constructor:V3D.Player,addModel:function(a,b){this.hero=a;this.hero.material=new THREE.MeshBasicMaterial({map:b,color:16777215,skinning:!0});this.hero.position.y=0.9;this.hero.scale.set(0.023,0.023,-0.023);this.animations=this.hero.animations;for(var d=this.animLength=a.animations.length,c;d--;)c=this.animations[d].name,this.W[c]="idle"===c?1:0,this.animations[d].weight=this.W[c],this.animations[d].play(0,this.W[c]);this.obj.add(this.hero);this.model=!0},loop:function(a){this.model&&
THREE.AnimationHandler.update(a)},getPosition:function(){return this.obj.position},setPosition:function(a,b,d){this.obj.position.set(a,b,d)},setRotation:function(a){this.rotation.y=a;this.isMove&&(this.newRotation.lerp(this.rotation,0.25),this.obj.rotation.y=this.newRotation.y)},lerp:function(a,b){this.obj.position.lerp(a,b)},WalkFront:function(){this.model&&(this.timeScale=1,this.ease({idle:0,walk:1,step_left:0,step_right:0}),this.isMove=!0)},WalkBack:function(){this.model&&(this.timeScale=-1,this.ease({idle:0,
walk:1,step_left:0,step_right:0}),this.isMove=!0)},stepLeft:function(){this.model&&(this.ease({idle:0,walk:0,step_left:1,step_right:0}),this.isMove=!0)},stepRight:function(){this.model&&(this.ease({idle:0,walk:0,step_left:0,step_right:1}),this.isMove=!0)},stopWalk:function(){!this.model||0===this.W.walk&&0===this.W.step_right&&0===this.W.step_left||(this.ease({idle:1,walk:0,step_left:0,step_right:0}),this.isMove=!1)},stop:function(a){},ease:function(a){var b=this;this.tween=(new TWEEN.Tween(this.W)).to(a,
200).easing(TWEEN.Easing.Linear.None).onUpdate(function(){b.weight()}).start()},weight:function(a){a=this.animLength;for(var b;a--;)b=this.animations[a].name,this.animations[a].weight=this.W[b],"walk"==b&&(this.animations[a].timeScale=this.timeScale)}};
